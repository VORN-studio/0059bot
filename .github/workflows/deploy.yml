name: Deploy to Hetzner

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: narek
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 1505
          script: |
            cd ${{ secrets.APP_PATH }}
            git fetch origin
            git reset --hard origin/main

            # Install FFmpeg if not present
            if ! command -v ffmpeg &> /dev/null; then
              echo "ðŸ“¦ Installing FFmpeg..."
              sudo apt update -qq
              sudo apt install -y -qq ffmpeg
              echo "âœ… FFmpeg installed"
            else
              echo "âœ… FFmpeg already installed"
            fi

            rm -rf venv
            python3 -m venv venv
            source venv/bin/activate
            pip install -q -r requirements.txt

            # Copy service file if changed
            sudo cp -f domino-bot.service /etc/systemd/system/domino-bot.service
            sudo systemctl daemon-reload
            sudo systemctl enable domino-bot
            sudo systemctl restart domino-bot

            # Update nginx config
            sudo cp -f nginx-domino.conf /etc/nginx/sites-available/domino-play.online
            sudo nginx -t && systemctl reload nginx

            # Remove old service if exists
            if systemctl is-enabled 0059bot.service 2>/dev/null; then
              systemctl stop 0059bot.service
              systemctl disable 0059bot.service
              rm -f /etc/systemd/system/0059bot.service
              systemctl daemon-reload
            fi